name: PR-Test-Fork-Branch
on:
  workflow_dispatch: {}
  pull_request:
    branches:
      - "main"

env:
  TRACEE_REF: ${{ github.event.inputs.tracee_ref || github.ref }}

jobs:
  generate-matrix:
    name: Generate Test Matrix
    runs-on: ubuntu-24.04
    outputs:
      mainline_matrix: ${{ steps.generate.outputs.mainline_matrix }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          ref: ${{ env.TRACEE_REF }}
      - name: Generate Matrix
        id: generate
        uses: ./.github/actions/generate-kernel-matrix

  kernel-tests-mainline:
    name: ${{ matrix.job_name }}
    needs:
      - generate-matrix
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include: ${{fromJson(needs.generate-matrix.outputs.mainline_matrix)}}
    steps:
      - name: Prepare Environment
        run: |
          mkdir -p /tmp/root /tmp/go /tmp/go-cache

      - name: "Checkout"
        uses: actions/checkout@v6
        with:
          submodules: true
          ref: ${{ env.TRACEE_REF }}

      - name: "Disable Unattended Upgrades"
        run: |
          sudo ./scripts/disable-unattended-upgrades.sh

      - name: "Setup Mainline Kernel"
        run: |
          chmod +x ./scripts/setup-mainline-kernel.sh
          sudo ./scripts/setup-mainline-kernel.sh "${{ matrix.kernel_version }}" --arch "${{ matrix.arch }}"

      - name: "Install Tooling & Dependencies"
        run: |
          sudo ./scripts/installation/install-deps-ubuntu.sh
          sudo ./scripts/installation/install-clang.sh
          # Install QEMU for the target architecture
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-system-arm qemu-user-static

      - name: "Build Tracee"
        run: |
          make tracee

      - name: "Run Tests in QEMU"
        run: |
          chmod +x ./tests/e2e-kernel-test-qemu.sh
          chmod +x ./tests/e2e-kernel-test-qemu-exec.sh
          ./tests/e2e-kernel-test-qemu.sh "${{ matrix.kernel_version }}" "${{ matrix.arch }}"

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: qemu-logs-${{ matrix.job_name }}
          path: |
            ./qemu-artifacts/
            /tmp/tracee*
          if-no-files-found: warn
